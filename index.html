<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
    <title>DevAI | Strict 2.5 Flash</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --primary: #238636; --border: #30363d; --sidebar: #010409; }
        [data-theme="light"] { --bg: #ffffff; --card: #f6f8fa; --text: #24292f; --primary: #0969da; --border: #d0d7de; --sidebar: #ebf0f4; }

        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; height: 100dvh; display: flex; overflow: hidden; }
        
        /* Sidebar Styles */
        #sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: 0.3s; z-index: 100; }
        .sidebar-header { padding: 15px; font-weight: bold; border-bottom: 1px solid var(--border); font-size: 14px; }
        #history-list { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; }
        .history-item { padding: 8px; border-radius: 6px; cursor: pointer; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border: 1px solid transparent; }
        .history-item:hover { background: var(--card); border-color: var(--border); }
        
        /* Portfolio Section (Non-intrusive) */
        .portfolio-link { padding: 15px; border-top: 1px solid var(--border); font-size: 12px; }
        .portfolio-link a { color: var(--primary); text-decoration: none; font-weight: bold; }

        /* Main Chat Area */
        .main-content { flex: 1; display: flex; flex-direction: column; position: relative; min-width: 0; }
        .header { padding: 10px 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        #progress-bar { width: 0%; height: 3px; background: var(--primary); transition: width 0.3s; }

        #chat-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; }
        .msg { max-width: 85%; padding: 12px; border-radius: 12px; font-size: 14px; line-height: 1.5; word-wrap: break-word; }
        .ai-msg { align-self: flex-start; background: var(--bg); border: 1px solid var(--border); }
        .user-msg { align-self: flex-end; background: var(--primary); color: white; }

        /* Mobile Optimized Input with 10px Gap */
        .input-area { padding: 10px; margin-bottom: 10px; background: var(--card); border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 8px; }
        .row { display: flex; gap: 8px; }
        input { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 8px; font-size: 16px; flex: 1; outline: none; }
        button#send-btn { background: var(--primary); color: white; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #cooldown { font-size: 11px; text-align: center; color: #8b949e; height: 14px; }

        /* Markdown & Code Snippets */
        pre { background: #000; padding: 12px; border-radius: 8px; overflow-x: auto; position: relative; margin: 10px 0; }
        code { font-family: 'Consolas', monospace; color: #79c0ff; font-size: 13px; }
        .copy-btn { position: absolute; top: 5px; right: 5px; font-size: 10px; background: #333; color: #fff; padding: 4px; border-radius: 4px; border: none; cursor: pointer; }

        /* Responsive Sidebar */
        @media (max-width: 768px) {
            #sidebar { position: absolute; left: -260px; height: 100%; }
            #sidebar.open { left: 0; }
            .menu-toggle { display: block; }
        }
        @media (min-width: 769px) { .menu-toggle { display: none; } }
    </style>
</head>
<body>

<aside id="sidebar">
    <div class="sidebar-header">Code History</div>
    <div id="history-list"></div>
    <div class="portfolio-link">
        Built by <a href="https://jolethen.github.io/" target="_blank">Jolethen Portfolio â†’</a>
    </div>
</aside>

<main class="main-content">
    <div class="header">
        <button class="menu-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')" style="background:none; border:1px solid var(--border); color:var(--text); padding:5px; border-radius:4px;">â˜°</button>
        <strong>DevAI 2.5 Flash</strong>
        <button onclick="toggleTheme()" style="background:none; border:1px solid var(--border); color:var(--text); padding:5px 10px; border-radius:4px;">ðŸŒ“</button>
    </div>
    <div id="progress-bar"></div>

    <div id="chat-box">
        <div class="msg ai-msg"><b>System:</b> Strict 2.5 Flash Mode. History tracking enabled. Build something great.</div>
    </div>

    <div class="input-area">
        <input type="password" id="api-key" placeholder="Enter API Key">
        <div class="row">
            <input type="text" id="user-input" placeholder="What are we building?">
            <button id="send-btn" onclick="sendMessage()">Send</button>
        </div>
        <div id="cooldown"></div>
    </div>
</main>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
    const converter = new showdown.Converter({ simpleLineBreaks: true, ghCodeBlocks: true, tables: true });
    let chatSession = null;
    let coolingDown = false;

    window.onload = () => {
        const key = localStorage.getItem('gemini_key');
        if (key) document.getElementById('api-key').value = key;
        document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');
        loadHistory();
    };

    window.toggleTheme = () => {
        const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
    };

    window.copyCode = (btn) => {
        const code = btn.parentNode.querySelector('code').innerText;
        navigator.clipboard.writeText(code);
        btn.innerText = "âœ“";
        setTimeout(() => btn.innerText = "Copy", 2000);
    };

    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('ai_history') || '[]');
        const list = document.getElementById('history-list');
        list.innerHTML = history.map(item => `<div class="history-item" title="${item}">${item}</div>`).reverse().join('');
    }

    async function streamResponse(text, container) {
        const html = converter.makeHtml(text);
        let i = 0;
        const interval = setInterval(() => {
            container.innerHTML = html.substring(0, i) + "â–ˆ";
            i += 6;
            if (i >= html.length) {
                clearInterval(interval);
                container.innerHTML = html.replace(/<pre><code/g, '<pre><button class="copy-btn" onclick="copyCode(this)">Copy</button><code');
                document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight;
            }
        }, 20);
    }

    window.sendMessage = async function() {
        if (coolingDown) return;
        const key = document.getElementById('api-key').value.trim();
        const input = document.getElementById('user-input');
        const prompt = input.value.trim();
        if (!key || !prompt) return;

        localStorage.setItem('gemini_key', key);
        
        // Update history
        const history = JSON.parse(localStorage.getItem('ai_history') || '[]');
        history.push(prompt);
        localStorage.setItem('ai_history', JSON.stringify(history.slice(-20))); // Keep last 20
        loadHistory();

        document.getElementById('chat-box').innerHTML += `<div class="msg user-msg">${prompt}</div>`;
        input.value = "";
        
        coolingDown = true;
        document.getElementById('send-btn').disabled = true;
        document.getElementById('progress-bar').style.width = "40%";

        try {
            const genAI = new GoogleGenerativeAI(key);
            // STRICT 2.5 FLASH CALL
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
            if (!chatSession) chatSession = model.startChat({ history: [] });

            const result = await chatSession.sendMessage(prompt);
            document.getElementById('progress-bar').style.width = "100%";
            
            const aiDiv = document.createElement('div');
            aiDiv.className = 'msg ai-msg';
            document.getElementById('chat-box').appendChild(aiDiv);
            await streamResponse(result.response.text(), aiDiv);
        } catch (e) {
            document.getElementById('chat-box').innerHTML += `<div class="msg ai-msg" style="color:red">Error: ${e.message}</div>`;
        }

        document.getElementById('progress-bar').style.width = "0%";
        let count = 5;
        const timer = setInterval(() => {
            document.getElementById('cooldown').innerText = `Cooling down: ${count}s`;
            count--;
            if (count < 0) {
                clearInterval(timer);
                coolingDown = false;
                document.getElementById('send-btn').disabled = false;
                document.getElementById('cooldown').innerText = "";
            }
        }, 1000);
    };
</script>
</body>
</html>

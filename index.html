<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevAI | 2.5 Stable Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --primary: #238636; --border: #30363d; --code-bg: #000; }
        [data-theme="light"] { --bg: #ffffff; --card: #f6f8fa; --text: #24292f; --primary: #0969da; --border: #d0d7de; --code-bg: #f1f1f1; }

        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .container { width: 100%; max-width: 900px; display: flex; flex-direction: column; background: var(--card); border-right: 1px solid var(--border); border-left: 1px solid var(--border); }
        .header { padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        /* Markdown & Bubble Styling */
        .msg { max-width: 85%; padding: 12px 18px; border-radius: 12px; font-size: 15px; line-height: 1.6; word-wrap: break-word; }
        .ai-msg { align-self: flex-start; background: var(--bg); border: 1px solid var(--border); }
        .user-msg { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        
        /* Code Block Styling */
        .code-container { position: relative; margin: 15px 0; }
        pre { background: var(--code-bg); padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid var(--border); margin: 0; }
        code { font-family: 'Consolas', 'Monaco', monospace; color: #79c0ff; font-size: 13px; }
        .copy-btn { position: absolute; top: 8px; right: 8px; padding: 4px 8px; font-size: 11px; background: #30363d; color: white; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; }

        .input-area { padding: 20px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        .row { display: flex; gap: 10px; }
        input { background: var(--bg); border: 1px solid var(--border); color: var(--text); padding: 12px; border-radius: 6px; outline: none; }
        button#send-btn { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 6px; font-weight: bold; cursor: pointer; }
        
        /* Markdown spacing fixes */
        .ai-msg p { margin: 8px 0; }
        .ai-msg ul, .ai-msg ol { margin: 8px 0; padding-left: 20px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <strong>DevAI Engineer (v2.5 Stable)</strong>
        <button onclick="toggleTheme()" style="background:none; border:1px solid var(--border); color:var(--text); cursor:pointer; padding:5px 10px; border-radius:4px;">ðŸŒ“ Theme</button>
    </div>

    <div id="chat-box">
        <div class="msg ai-msg"><b>System:</b> Connected to Gemini 2.5 Flash. Key is active and saved locally. Ready to build.</div>
    </div>

    <div class="input-area">
        <input type="password" id="api-key" placeholder="Paste API Key (AIzaSy...)">
        <div class="row">
            <input type="text" id="user-input" style="flex:1" placeholder="Describe the code you need...">
            <button id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // Setup Markdown Converter
    const converter = new showdown.Converter({
        tables: true,
        strikethrough: true,
        simpleLineBreaks: true,
        ghCodeBlocks: true
    });

    let chatSession = null;

    window.onload = () => {
        const savedKey = localStorage.getItem('gemini_key');
        if (savedKey) document.getElementById('api-key').value = savedKey;
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
    };

    window.toggleTheme = () => {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    };

    window.copyCode = (btn) => {
        const code = btn.parentNode.querySelector('code').innerText;
        navigator.clipboard.writeText(code);
        btn.innerText = "Copied!";
        setTimeout(() => btn.innerText = "Copy", 2000);
    };

    window.sendMessage = async function() {
        const keyInput = document.getElementById('api-key');
        const userInput = document.getElementById('user-input');
        const chatBox = document.getElementById('chat-box');

        const key = keyInput.value.trim();
        const prompt = userInput.value.trim();

        if (!key || !prompt) return;

        localStorage.setItem('gemini_key', key);
        chatBox.innerHTML += `<div class="msg user-msg">${prompt}</div>`;
        userInput.value = "";
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            const genAI = new GoogleGenerativeAI(key);
            
            // STRICTLY USING THE STABLE 2.5 MODEL
            const model = genAI.getGenerativeModel({ 
                model: "gemini-2.5-flash",
                systemInstruction: "You are a Senior AI Engineer. Provide clean code. Use Markdown. Always wrap code in triple backticks."
            });

            if (!chatSession) {
                chatSession = model.startChat({ history: [] });
            }

            const result = await chatSession.sendMessage(prompt);
            const response = await result.response;
            let text = response.text();

            // Convert Markdown to HTML
            let htmlContent = converter.makeHtml(text);

            // Add Copy Buttons to generated code blocks
            htmlContent = htmlContent.replace(/<pre><code([\s\S]*?)<\/code><\/pre>/g, (match) => {
                return `<div class="code-container"><button class="copy-btn" onclick="copyCode(this)">Copy</button>${match}</div>`;
            });

            chatBox.innerHTML += `<div class="msg ai-msg">${htmlContent}</div>`;
        } catch (e) {
            chatBox.innerHTML += `<div class="msg ai-msg" style="color:#ff7b72"><b>Error:</b> ${e.message}</div>`;
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    };
</script>

</body>
</html>

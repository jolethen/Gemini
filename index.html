<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevAI | Pro Coder</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <style>
        :root { --bg: #0d1117; --card: #161b22; --text: #c9d1d9; --primary: #238636; --border: #30363d; --code-bg: #000; }
        [data-theme="light"] { --bg: #ffffff; --card: #f6f8fa; --text: #24292f; --primary: #0969da; --border: #d0d7de; --code-bg: #f1f1f1; }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; height: 100vh; }
        .container { width: 100%; max-width: 900px; display: flex; flex-direction: column; background: var(--card); border: 1px solid var(--border); }
        .header { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        /* Markdown Styling */
        .msg { max-width: 90%; padding: 12px 18px; border-radius: 12px; font-size: 15px; line-height: 1.6; }
        .ai-msg { align-self: flex-start; background: var(--bg); border: 1px solid var(--border); }
        .user-msg { align-self: flex-end; background: var(--primary); color: white; }
        
        /* Code Block Styling */
        .code-container { position: relative; margin: 15px 0; }
        pre { background: var(--code-bg); padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid var(--border); }
        code { font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; color: #79c0ff; }
        .copy-btn { position: absolute; top: 10px; right: 10px; padding: 5px 10px; font-size: 11px; background: #30363d; color: white; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; }
        .copy-btn:hover { background: #444; }

        .input-area { padding: 20px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 10px; }
        .row { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
        button#send-btn { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 6px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <strong>DevAI Engineer 3.1</strong>
        <button onclick="toggleTheme()" style="background:none; border:1px solid var(--border); color:var(--text); cursor:pointer; border-radius:4px;">ðŸŒ“</button>
    </div>
    <div id="chat-box"></div>
    <div class="input-area">
        <input type="password" id="api-key" placeholder="Paste API Key (Saved)...">
        <div class="row">
            <input type="text" id="user-input" placeholder="Type your coding request...">
            <button id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const converter = new showdown.Converter({ tables: true, strikethrough: true, simpleLineBreaks: true });
    let chatSession = null;

    window.onload = () => {
        const savedKey = localStorage.getItem('gemini_key');
        if (savedKey) document.getElementById('api-key').value = savedKey;
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
    };

    window.toggleTheme = () => {
        const current = document.documentElement.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    };

    // Function to copy code to clipboard
    window.copyCode = (btn) => {
        const code = btn.parentNode.querySelector('code').innerText;
        navigator.clipboard.writeText(code);
        btn.innerText = "Copied!";
        setTimeout(() => btn.innerText = "Copy", 2000);
    };

    window.sendMessage = async function() {
        const key = document.getElementById('api-key').value.trim();
        const input = document.getElementById('user-input');
        const prompt = input.value.trim();
        const chatBox = document.getElementById('chat-box');

        if (!key || !prompt) return;
        localStorage.setItem('gemini_key', key);

        chatBox.innerHTML += `<div class="msg user-msg">${prompt}</div>`;
        input.value = "";

        try {
            const genAI = new GoogleGenerativeAI(key);
            const model = genAI.getGenerativeModel({ 
                model: "gemini-3.1-flash",
                systemInstruction: "You are a Senior AI Engineer. Use professional markdown. Wrap all code in triple backticks. Use bolding for emphasis."
            });

            if (!chatSession) chatSession = model.startChat({ history: [] });

            const result = await chatSession.sendMessage(prompt);
            const response = await result.response;
            let rawText = response.text();

            // Convert Markdown to HTML
            let htmlContent = converter.makeHtml(rawText);

            // Wrap <code> tags in a container with a Copy button
            htmlContent = htmlContent.replace(/<pre><code([\s\S]*?)<\/code><\/pre>/g, (match) => {
                return `<div class="code-container"><button class="copy-btn" onclick="copyCode(this)">Copy</button>${match}</div>`;
            });

            chatBox.innerHTML += `<div class="msg ai-msg">${htmlContent}</div>`;
        } catch (e) {
            chatBox.innerHTML += `<div class="msg ai-msg" style="color:red">Error: ${e.message}</div>`;
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    };
</script>
</body>
</html>
